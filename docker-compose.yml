services:
  voice-postgres:
    image: postgres:16-alpine
    container_name: voice-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-voice_recognition}
      POSTGRES_USER: ${POSTGRES_USER:-voice}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-voice_secret}
    ports:
      - "5435:5432"
    volumes:
      - voice_postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-voice}"]
      interval: 5s
      timeout: 5s
      retries: 5

  voice-redis:
    image: redis:7-alpine
    container_name: voice-redis
    ports:
      - "6382:6379"
    volumes:
      - voice_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  voice-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: voice-api
    ports:
      - "8200:8000"
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-voice}:${POSTGRES_PASSWORD:-voice_secret}@voice-postgres:5432/${POSTGRES_DB:-voice_recognition}
      REDIS_URL: redis://voice-redis:6379/0
      UPLOAD_DIR: /app/uploads
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
    volumes:
      - ./uploads:/app/uploads
    depends_on:
      voice-postgres:
        condition: service_healthy
      voice-redis:
        condition: service_healthy

  voice-worker:
    build:
      context: ./worker
      dockerfile: Dockerfile
    container_name: voice-worker
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-voice}:${POSTGRES_PASSWORD:-voice_secret}@voice-postgres:5432/${POSTGRES_DB:-voice_recognition}
      REDIS_URL: redis://voice-redis:6379/0
      UPLOAD_DIR: /app/uploads
      OLLAMA_URL: http://voice-ollama:11434
      HF_TOKEN: ${HF_TOKEN}
    volumes:
      - ./uploads:/app/uploads
      - whisperx_cache:/root/.cache
    depends_on:
      voice-postgres:
        condition: service_healthy
      voice-redis:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  voice-ollama:
    image: ollama/ollama:latest
    container_name: voice-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  voice-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: voice-frontend
    ports:
      - "3200:3000"
    environment:
      NEXT_PUBLIC_API_URL: http://voice-api:8000
      NEXT_PUBLIC_WS_URL: ws://voice-api:8000
    depends_on:
      - voice-api

volumes:
  voice_postgres_data:
  voice_redis_data:
  ollama_data:
  whisperx_cache:
